@model MDS.Models.ServiceWorkOderSearch
<style type="text/css">
    td {
        padding: 5px;
    }
</style>
<table align="center" width="100%">
    <tr>
        <td align="left"><b>
    @Html.ActionLink("<- Return to Service Job", "Edit", new { id = Model.ServiceJobID }, new { style = "font-size:16px" })
</b>
        </td>
        <td>
            <h2 style="text-align: left;">Service Work Order Search</h2>
        </td>
    </tr>
</table>
@using (Html.BeginForm("GetWOForService", "Service", FormMethod.Post, new { id = "SWOForm" }))
{
    <div class="contact-info">
        <div class="content">
            <table width="100%">
                <tr>
                    <td width="16%">Show services performed since filter:</td>
                    <td width="16%">
                        @if (Model.ServicesAfterDateFilter)
                        {
                            @Html.CheckBox("chkServicesAfterDateFilter", true)
                        }
                        else
                        {
                            @Html.CheckBox("chkServicesAfterDateFilter", false)
                        }

                    </td>
                    <td width="16%" class="dateout">Only show services performed since</td>
                    <td width="16%" class="dateout">@(Html.Kendo().DatePickerFor(m => m.ServicesAfterDate)
                            .Name("ServicesAfterDate")
                            .Value("01/01/2000")
                            .Format("dd/MM/yyyy")
                            .ParseFormats(new string[] { "dd/MM/yyyy" })
.HtmlAttributes(new { style = "width:120px", type = "text" })
                            )</td>
                    <td width="16%">Only display incomplete service records
                    </td>
                    <td width="16%">

                        @Html.CheckBoxFor(m => m.DataEntryIncompeteOnly, new { Name = "DataEntryIncompeteOnly" })

                    </td>
                </tr>

                <tr>
                    <td>Equipment Item: </td>
                    <td>@Html.HiddenFor(m => m.SelectedEquipment)
                        @Html.HiddenFor(m => m.EquipmentData)
                        @(Html.Kendo().Window()
                            .Name("window1")
                            .Title("Equipment Search")
                            .Width(1000)
                            .Height(500)
                            .Visible(false)
                            .Iframe(true)
                            .Modal(true)
                            .Events(e => e.Close("onClose1"))
                            ) <a onclick="openEquipmemtWindow();" class="button"><span style="font-weight: bold">Pick Equipment</span></a></td>

                    <td colspan="3"><span id="spDetails1"></span></td>
                    <td><a onclick="ClearEquipment();" id="btnEquipmentClear" class="button"><span style="font-weight: bold">Clear Equipment</span></a> </td>
                </tr>
                <tr>
                    <td>Service Job:</td>
                    <td colspan="5"><span id="spDetails"></span></td>
                </tr>
                <tr>
                    <td width="70">Equip Type :
                    </td>
                    <td>
                        @(Html.Kendo().DropDownListFor(m => m.Equiptype)
                              .Name("Equiptype")
                              .DataTextField("Name")
                               .Filter("startswith")
                              .DataValueField("EquipTypeCode")
                              .BindTo(Model.EquipTypeList)
                              .HtmlAttributes(new { style = "width:150px", data_required_msg = "Equip Type is required." })
                        )

                    </td>
                    <td width="60">Engineer:
                    </td>
                    <td>@(Html.Kendo().DropDownListFor(m => m.EngineerID)
                            .Name("EngineerID")
                             .Filter("startswith")
                            .DataTextField("EngineerName")
                            .DataValueField("EngineerID")
                              .BindTo(Model.EngineerList)
                              .HtmlAttributes(new { style = "width:150px", data_required_msg = "Engineer is required." })
                            )

                    </td>
                    <td>Branch:</td>


                    <td>@(Html.Kendo().DropDownListFor(m => m.Branchid)
                          .Name("Branchid")
                           .Enable(MDS.Controllers.LoginController.AllCustomers(User.Identity.Name))

                          .DataTextField("BranchName")
                          .DataValueField("BranchID")
                          .BindTo(Model.BranchList)
                          .HtmlAttributes(new { style = "width:150px", data_required_msg = "Branch is required." })
                        )</td>
                </tr>
                <tr>
                    <td width="60">Customer:
                    </td>
                    <td>@(Html.Kendo().DropDownListFor(m => m.Customerid)
                          .Name("Customerid")
                           .Filter(MDS.Controllers.LoginController.SearchType)
                          .DataTextField("CompanyName")
                          .DataValueField("CustomerCode")
                          .BindTo(Model.CustomerList)
                          .HtmlAttributes(new { style = "width:150px", data_required_msg = "Customer is required." })
                        )

                    </td>
                    <td width="100">Customer-Site:
                    </td>
                    <td>@(Html.Kendo().DropDownListFor(m => m.Department)
                          .Name("Department")
                          .DataTextField("Department")
                          .DataValueField("DepartmentID")
                          .DataSource(dataSource =>
                                  {
                                      dataSource.Read(read =>
                                      {
                                          read.Action("GetCustomerSiteX", "Service")
                                             .Data("CustomerSiteData");
                                      })
                                      .ServerFiltering(true);
                                  })
                                  .AutoBind(false)
                                 .CascadeFrom("Customerid")
                                 

                          .HtmlAttributes(new { style = "width:150px", data_required_msg = "Customer Site is required." })
                        )
                    </td>
                    <td>Location:
                    </td>
                    <td>@(Html.Kendo().DropDownListFor(m => m.Location)
                                .Name("Location")
                                .DataTextField("Location")
                                .DataValueField("Locationid")
                                .DataSource(dataSource =>
                                  {
                                      dataSource.Read(read =>
                                      {
                                          read.Action("GetCustomerLocation", "Service")
                                             .Data("CustomerSiteData");
                                      })
                                      .ServerFiltering(true);
                                  })
                                  .AutoBind(false)
                                 .CascadeFrom("Customerid")
                                .HtmlAttributes(new { style = "width:150px" })
                            )
                    </td>
                </tr>
                <tr>

                      <td colspan="2">
        <table>
            <tr style="color:navy">
<td>
    Limit number of Records to no more than:
</td>
<td>
    @(Html.Kendo().DropDownListFor(m => m.SelCnt)
                          .Name("SelCnt")
                          .BindTo(Model.Cnt)
                          .HtmlAttributes(new { style = "width:100%", data_required_msg = "Records is required." })
             
                          )
    </td>
    </tr>
    </table>
</td>
                    <td colspan="2">
                        <a class="button" onclick="$('#SWOForm').submit();"><span>Search</span></a>
                        <a onclick="cancel();" class="button"><span>Cancel</span></a>
                    </td>
                    <td colspan="4">
                        <a class="button" id="btnCreateRepairJobForWorkOrdersNotServiceable" style="display: none;"><span>Create a Repair Job For all the listed Work Orders Not marked as Serviceable</span></a>
                    </td>
                </tr>

                <tr>
                    <td colspan="6">&nbsp;
                    </td>
                </tr>
            </table>
            <table width="100%">
                <tr>
                    <td colspan="6">

                        <input type="button" class="inputbuttonbg inputbig" value="Add New Work Order" onclick="AddWorkOrder()">
                        <input type="button" class="inputbuttonbg inputbig" value="Delete Service Work Order" id="btnDelete">
                    </td>
                </tr>
                <tr>
                    <td colspan="6">
                        @(Html.Kendo().Grid(Model.ServiceWorkOrder)
.Name("swoGrid")
.Columns(columns =>
{
    if (ViewBag.PopUpService != null) { columns.Bound(p => p.Equipment).Title("Equipment").ClientTemplate(@Html.ActionLink("#=Equipment#", "EditPopUpService", "ServiceWorkOrder", new { id = "#=ServiceId#" }, null).ToHtmlString()); }
    else { columns.Bound(p => p.Equipment).Title("Equipment").ClientTemplate(@Html.ActionLink("#=Equipment#", "Edit", "ServiceWorkOrder", new { id = "#=ServiceId#" }, null).ToHtmlString()); }

    columns.Bound(p => p.ServiceId).Visible(false);
    columns.Bound(p => p.CompanyName).Title("Company Name");
    columns.Bound(p => p.ServiceArea).Title("Service Area");
    columns.Bound(p => p.WorkDone).Title("Work Done");
    columns.Bound(p => p.NotesForThisService).Title("Notes");
    columns.Bound(p => p.DateServiced).Title("Date Serviced").ClientTemplate("#= (DateServiced == null) ? ' ' : kendo.toString(DateServiced, 'dd/MM/yyyy') #");
    columns.Bound(p => p.EngineerName).Title("Engineer Name");
    columns.Bound(p => p.Parts).Title("Parts Used");
})
.Pageable()
.Sortable()
.Filterable()
.Selectable(s => s.Mode(GridSelectionMode.Single))
 .DataSource(dataSource => dataSource
        .Ajax()
        .PageSize(200)
        .ServerOperation(false)
     )
)
                    </td>
                </tr>
            </table>
        </div>
    </div>
   
    @Html.HiddenFor(m => m.ServiceJobID)
    @Html.HiddenFor(m => m.ServiceData)
    @Html.HiddenFor(m => m.ServiceClear)
    @Html.HiddenFor(m => m.EquipmentClear)
    @Html.HiddenFor(m => m.ServicesAfterDateFilter)
    <input id="hdServiceId" type="hidden" />
    @(Html.Kendo().Window()
                                            .Name("serviceworkorderwindow")
                                            .Title("Service Workorder Detail")
                                            .Width(1000)
                                            .Height(600)
                                            .Visible(false)
                                            .Iframe(true)
                                             .Modal(true)
                                               .Events(e => e.Close("CloseWoWindow"))
                                            )
    
    
}

<script>
    var flag = 1;
    $(document).ready(function () {

        $("#spDetails").text('@Model.ServiceData');
        $("#spDetails1").text('@Model.EquipmentData');

        var EquipClear = '@Model.EquipmentClear';
        var ServiceClear = '@Model.ServiceClear';
        var RepairClear = '@Model.RepairClear';

        if (EquipClear == "C")
        { $("#btnEquipmentClear").show(); }
        else { $("#btnEquipmentClear").hide(); }

        if (RepairClear == "C")
        { $("#btnCreateRepairJobForWorkOrdersNotServiceable").show(); }
        else { $("#btnCreateRepairJobForWorkOrdersNotServiceable").hide(); }

        if (ServiceClear == "C")
        { $("#btnServiceClear").show(); }
        else { $("#btnServiceClear").hide(); }


        if ($("#spDetails").text() != "") {
            $("#btnCreateRepairJobForWorkOrdersNotServiceable").show();
        }
        $("#chkServicesAfterDateFilter").click(function () {
            if ($(this).is(":checked")) {
                $(".dateout").show();
                $("#ServicesAfterDateFilter").val(true);
            }
            else {
                $(".dateout").hide();
                $("#ServicesAfterDateFilter").val(false);
            }
        });
        var ServicesAfterDateFilter = '@Model.ServicesAfterDateFilter';
        if (ServicesAfterDateFilter == "True") {
            $(".dateout").show();
        }
        else {
            $(".dateout").hide();
        }

        $("#btnCreateRepairJobForWorkOrdersNotServiceable").click(function (event) {
            event.preventDefault();
            $("#divProgress").show();
            $.post('@Url.Action("CreateRepairJob", "ServiceWorkOrder")', $("#SWOForm").serialize(), function (data) {
                $("#divProgress").hide();
                window.location.href = '/repair';
            });
        });

    });

    $("#btnDelete").click(function () {
        var entityGrid = $("#swoGrid").data("kendoGrid");
        var selectedItem = entityGrid.dataItem(entityGrid.select());
        if (selectedItem == undefined) {
            ShowAlert("Please select the service work order first");
        }
        else {

            swal({
                title: "",
                text: "Are you SURE you want to delete this service work order now?",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "green",
                confirmButtonText: "Yes",
                cancelButtonText: "No",
                closeOnConfirm: true,
                closeOnCancel: true
            },
                function (isConfirm) {
                    if (isConfirm) {
                        var ServiceId = selectedItem.ServiceId;
                        $.ajax({
                            url: '@Url.Action("DeleteServiceWokOrder", "ServiceWorkOrder")',
                            type: 'POST',
                            datatype: "json",
                            data: { ServiceID: ServiceId },
                            success: function (response) {
                                alert(response.msg);
                                if (response.msg.indexOf("Successfully") >= 0) {
                                    $("#SWOForm").submit();
                                }
                            },
                            error: function (req, status, error) {
                            }
                        });
                    }
                    else {
                    }
                });

        }
    });
function CustomerSiteData() {
    return {
        Customerid: $("#Customerid").val(),
        Branchid: $("#Branchid").val()
    };
}

function AddWorkOrder() {
    flag = 0;
   
    OpenWindow2();
}

function ClearEquipment() {
    $('#EquipmentClear').val("");
    $("#SelectedEquipment").val("-1");
    $("#btnEquipmentClear").hide();
    $("#EquipmentData").val("");
    $('#spDetails1').text("");
}

function ClearService() {
    $('#ServiceClear').val("");
    $("#ServiceJobID").val("-1");
    $("#btnServiceClear").hide();
    $('#ServiceData').val("");
    $('#spDetails').text("");
    $("#btnCreateRepairJobForWorkOrdersNotServiceable").hide();
}
function CloseWoWindow(e) {
    $('#SWOForm').submit();
}
function OpenWindow() {

    var window = $("#window").data("kendoWindow");

    window.Visible = true;
    var actionURL = '@Url.Action("SearchServiceJobLoad", "ServiceWorkOrder")';
    window.refresh({
        url: actionURL,
        data: {}
    });
    var width95 = (screen.width) * 85 / 100;
    var height75 = (screen.height) * 65 / 100;
    window.setOptions({ width: width95, height: height75 });
    window.center();
    window.open();
}

function onClose(e) {
    $.ajax({
        url: '@Url.Action("GetServiceJobDetails", "ServiceWorkOrder")',
        type: 'POST',
        datatype: "json",
        data: { ServiceJobId: $("#ServiceJobID").val() },
        success: function (response) {
            $('#spDetails').text(response.ServiceInfo);
            $('#ServiceData').val(response.ServiceInfo);
            $("#btnCreateRepairJobForWorkOrdersNotServiceable").show();
            $('#ServiceClear').val("C");
            $('#RepairClear').val("C");
            $('#SWOForm').submit();
        },
        error: function (req, status, error) {
            //  alert("R: " + req + " S: " + status + " E: " + error);
        }
    });
}

function openEquipmemtWindow() {
    flag = 1;
    OpenWindow1();
}

function OpenWindow1() {

    var window1 = $("#window1").data("kendoWindow");

    window1.Visible = true;
    var actionURL = '@Url.Action("SearchEquipmentLoad", "Repair")';
    window1.refresh({
        url: actionURL,
        data: {}
    });
    var width95 = (screen.width) * 85 / 100;
    var height75 = (screen.height) * 65 / 100;
    window1.setOptions({ width: width95, height: height75 });
    window1.center();
    window1.open();
}

function OpenWindow2() {
    
    var window1 = $("#window1").data("kendoWindow");
  
    window1.Visible = true;

    $.ajax({
        url: '@Url.Action("GetCustomerCode", "ServiceWorkOrder")',
         type: 'POST',
         datatype: "json",
         data: { id: '@ViewBag.PopUpService' },
         success: function (response) {
             //alert(response.CustomerCode);
             var actionURL = '@Url.Action("SearchEquipmentLoadByCustomerCode", "Repair")' + '/' + response.CustomerCode;
             window1.refresh({
                 url: actionURL,
                 data: {}
             });
             var width95 = (screen.width) * 85 / 100;
             var height75 = (screen.height) * 65 / 100;
             window1.setOptions({ width: width95, height: height75 });
             window1.center();
             window1.open();
         },
         error: function (req, status, error) {
             //  alert("R: " + req + " S: " + status + " E: " + error);
         }
     });

   
    }

    function onClose1(e) {
        if (flag == 1) {
            $.ajax({
                url: '@Url.Action("GetEquipInfomationData", "Repair")',
            type: 'POST',
            datatype: "json",
            data: { EquipUID: $("#SelectedEquipment").val() },
            success: function (response) {
                $('#spDetails1').text(response.CustomerInfo);
                $('#EquipmentData').val(response.CustomerInfo);
                $("#btnEquipmentClear").show();
                $('#EquipmentClear').val("C");
            },
            error: function (req, status, error) {
                //  alert("R: " + req + " S: " + status + " E: " + error);
            }
        });
    }
    else {

        $("#divProgress").show();
        var ServiceId = '@ViewBag.PopUpService';
            $.ajax({
                url: '@Url.Action("CreateWOfromJobAssociated", "ServiceWorkOrder")',
                type: 'POST',
                datatype: "json",
                data: { ID: ServiceId, EquipUID: $("#SelectedEquipment").val() },
                success: function (response) {
                    $("#divProgress").hide();
                   
                        var window = $("#serviceworkorderwindow").data("kendoWindow");
                        window.Visible = true;
                        var actionURL = '@Url.Action("EditPopupAssociated", "ServiceWorkOrder")';
                        window.refresh({
                            url: actionURL
                        });
                        var width95 = (screen.width) * 85 / 100;
                        var height75 = (screen.height) * 65 / 100;
                        window.setOptions({ width: width95, height: height75 });
                        window.center();
                        window.open();
                    
                },
                error: function (req, status, error) {
                    //  alert("R: " + req + " S: " + status + " E: " + error);
                }
            });
        }
    }

    function createWO() {
        var entityGrid = $("#swoGrid").data("kendoGrid");
        var selectedItem = entityGrid.dataItem(entityGrid.select());
        if (selectedItem == undefined) {
            alert("Please select existing from which to Equipment, customer, engineer will be copied to new require");
        }
        else {
            var r = confirm("Are you sure you wish to create new Service work order based on existing?");
            if (r) {
                $("#divProgress").show();
                var ServiceId = selectedItem.ServiceId;
                $.ajax({
                    url: '@Url.Action("CreateWO", "ServiceWorkOrder")',
                    type: 'POST',
                    datatype: "json",
                    data: { ID: ServiceId },
                    success: function (response) {
                        $("#divProgress").hide();
                        window.location.href = "ServiceWorkOrder/Edit/" + response.NewServiceID;
                    },
                    error: function (req, status, error) {
                        //  alert("R: " + req + " S: " + status + " E: " + error);
                    }
                });
            }

        }
    }

    function cancel() {
        parent.$("#WOwindow").data("kendoWindow").close();
    }
</script>

